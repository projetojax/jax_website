{% extends 'base.html' %}
{% block title %}Empresarial - JAX{% endblock %}

{% block content %}
<div class="edu-container">
  <header class="edu-top">
    <h1>üè¢ Universo Empresarial JAX</h1>
    <div class="edu-actions">
      <button id="btnFull" class="btn">üïπÔ∏è Tela Cheia</button>
      <button id="btnMute" class="btn">üîä Som</button>
      <div class="hint">Use WASD ou setas para se mover ‚Äî clique no personagem para focar</div>
    </div>
  </header>

  <div class="game-wrap">
    <div id="viewport" class="viewport">
      <div id="map" class="map">
        <!-- fundo -->
        <div class="layer bg far" style="background-image:url('{{ url_for('static', filename='img/empresa/empresa.jpg') }}');"></div>
        <div class="layer bg mid" style="background-image:url('{{ url_for('static', filename='img/empresa/empresa.jpg') }}'); opacity:0.9;"></div>

        <!-- setores -->
        <div class="zone zone-recepcao" data-zone="recepcao" data-allowed="true" title="Recep√ß√£o">
          <img src="{{ url_for('static', filename='img/empresa/recepcao.jpg') }}" alt="Recep√ß√£o">
          <div class="zone-label">Recep√ß√£o</div>
        </div>

        <div class="zone zone-coworking" data-zone="coworking" data-allowed="true" title="Sala Coworking">
          <img src="{{ url_for('static', filename='img/empresa/sala-coworking.jpg') }}" alt="Coworking">
          <div class="zone-label">Sala Coworking</div>
        </div>

        <div class="zone zone-tecnica" data-zone="tecnica" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}" title="Sala T√©cnica">
          <img src="{{ url_for('static', filename='img/empresa/sala-tecnica.jpg') }}" alt="Sala T√©cnica">
          <div class="zone-label">Sala T√©cnica</div>
        </div>

        <div class="zone zone-pessoas" data-zone="pessoas" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}" title="Sala de Pessoas">
          <img src="{{ url_for('static', filename='img/empresa/sala-pessoas.jpeg') }}" alt="Sala de Pessoas">
          <div class="zone-label">Sala de Pessoas</div>
        </div>

        <div class="zone zone-comercial" data-zone="comercial" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}" title="Sala Comercial">
          <img src="{{ url_for('static', filename='img/empresa/sala-comercial.jpg') }}" alt="Sala Comercial">
          <div class="zone-label">Sala Comercial</div>
        </div>

        <div class="zone zone-reunioes" data-zone="reunioes" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}" title="Sala de Reuni√µes">
          <img src="{{ url_for('static', filename='img/empresa/sala-reunioes.jpg') }}" alt="Sala de Reuni√µes">
          <div class="zone-label">Sala de Reuni√µes</div>
        </div>

        <!-- NPC -->
        <img class="decor npc npc-1" src="{{ url_for('static', filename='img/empresa/npc.png') }}" alt="NPC">

        <!-- personagem -->
        <div id="player" class="player" tabindex="0" aria-label="Personagem">
          <img id="playerSprite" src="{{ url_for('static', filename='img/empresa/personagem.jpg') }}" alt="Personagem">
        </div>
      </div>
    </div>

    <!-- painel lateral -->
    <aside class="panel">
      <div class="panel-block">
        <h3>Localiza√ß√£o</h3>
        <div id="location">Recep√ß√£o</div>
      </div>

      <div class="panel-block">
        <h3>A√ß√µes r√°pidas</h3>
        <button class="tele" data-target="recepcao">Ir √† Recep√ß√£o</button>
        <button class="tele" data-target="coworking">Ir ao Coworking</button>
        <button class="tele" data-target="tecnica" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}">Ir √† Sala T√©cnica</button>
        <button class="tele" data-target="pessoas" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}">Ir √† Sala de Pessoas</button>
        <button class="tele" data-target="comercial" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}">Ir √† Sala Comercial</button>
        <button class="tele" data-target="reunioes" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}">Ir √† Sala de Reuni√µes</button>
      </div>

      <div class="panel-block">
        <h3>Status</h3>
        <div id="statusMsg">Bem-vindo ao universo empresarial.</div>
        <div class="small">Seu acesso:
          {% if current_user %}
            {{ current_user.profile }}
          {% else %}
            visitante
          {% endif %}
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- üî• MODAL DE BOAS-VINDAS -->
<div id="modalMPC" class="modal hidden">
  <div class="modal-content">
    <h2>üè¢ Bem-vindo!</h2>
    <p>Seja bem-vindo ao Universo Empresarial do JAX! Aqui voc√™ ir√° entender como funciona o mercado de trabalho e estar pronto pra lidar com ele.</p>
    <button id="closeModal" class="btn">Entrar na Empresa</button>
  </div>
</div>

<style>
{% raw %}
:root{
  --bg:#f0f4ff; --panel:#ffffff; --accent:#1d4ed8;
  --map-w:2600px; --map-h:1400px;
  font-family: Inter, system-ui, -apple-system, Roboto, sans-serif;
}

.edu-container{padding:1rem 1.25rem}
.edu-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
.edu-top h1{font-size:1.2rem;margin:0;color:#1e293b;}
.edu-actions{display:flex;align-items:center;gap:.6rem}
.btn{padding:.45rem .65rem;border-radius:8px;border:0;background:var(--panel);box-shadow:0 6px 18px rgba(12,40,80,0.06);cursor:pointer;font-weight:600;}

.game-wrap{display:flex;gap:1rem;align-items:flex-start}
.viewport{width:1000px;height:600px;border-radius:12px;overflow:hidden;border:1px solid rgba(15,23,36,0.06);background:linear-gradient(180deg,#dbeafe,#eff6ff);position:relative}
.map{width:var(--map-w);height:var(--map-h);position:relative;transform-origin:0 0}

.layer.bg{position:absolute;inset:0;background-size:cover;background-position:center;will-change:transform}
.layer.far{filter:brightness(.95) saturate(.95);transform:translateZ(-1px) scale(1.05)}
.layer.mid{opacity:.95}

.zone{position:absolute;border-radius:12px;overflow:hidden;border:2px solid rgba(255,255,255,0.5);box-shadow:0 16px 40px rgba(6,20,60,0.06);display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-end}
.zone img{width:100%;height:100%;object-fit:cover;display:block}
.zone-label{background:linear-gradient(90deg,rgba(255,255,255,0.95),rgba(255,255,255,0.85));padding:.35rem .6rem;border-radius:10px;margin:8px;font-weight:700;font-size:.9rem;color:#0f1724;box-shadow:0 6px 18px rgba(12,40,80,0.04)}

.zone-recepcao{left:140px;top:120px;width:620px;height:360px}
.zone-coworking{left:820px;top:110px;width:640px;height:360px}
.zone-tecnica{left:140px;top:520px;width:640px;height:360px}
.zone-pessoas{left:820px;top:520px;width:620px;height:260px}
.zone-comercial{left:1550px;top:120px;width:620px;height:360px}
.zone-reunioes{left:1550px;top:520px;width:620px;height:300px}

.player{position:absolute;width:64px;height:80px;left:600px;top:400px;transform:translate(-50%,-50%);z-index:40;outline:none}
.player img{width:64px;height:80px;display:block;pointer-events:none;user-select:none}

.npc{position:absolute;width:110px;height:150px;left:700px;top:420px;z-index:30;border-radius:6px;object-fit:cover;box-shadow:0 8px 30px rgba(6,20,60,0.06)}

.panel{width:280px;display:flex;flex-direction:column;gap:.7rem}
.panel-block{background:var(--panel);padding:.7rem;border-radius:10px;box-shadow:0 8px 24px rgba(12,40,80,0.05)}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity .3s ease;}
.modal.hidden{opacity:0;pointer-events:none;}
.modal-content{background:#fff;padding:2rem;border-radius:14px;max-width:520px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.25);animation:popIn .4s ease;}
.modal-content h2{color:#1d4ed8;margin-bottom:.5rem;font-size:1.5rem;}
.modal-content p{font-size:1rem;color:#334155;margin-bottom:1.2rem;}
.modal-content .btn{background:#1d4ed8;color:#fff;padding:.5rem 1rem;border-radius:8px;border:none;cursor:pointer;font-weight:600;}
@keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}

{% endraw %}
</style>

<script>
const PERMS = {
  recepcao: true,
  coworking: true,
  tecnica: {{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }},
  pessoas: {{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }},
  comercial: {{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }},
  reunioes: {{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}
};

(function(){
  const viewport=document.getElementById('viewport');
  const map=document.getElementById('map');
  const player=document.getElementById('player');
  const playerSprite=document.getElementById('playerSprite');
  const zones=Array.from(document.querySelectorAll('.zone'));
  const locationBox=document.getElementById('location');
  const statusBox=document.getElementById('statusMsg');
  const modal=document.getElementById('modalMPC');
  const closeModal=document.getElementById('closeModal');
  let modalShown=false;
  closeModal.addEventListener('click',()=>modal.classList.add('hidden'));

  const MAP_W=parseInt(getComputedStyle(map).width);
  const MAP_H=parseInt(getComputedStyle(map).height);
  const VIEW_W=viewport.clientWidth;
  const VIEW_H=viewport.clientHeight;
  let cam={x:0,y:0};
  const speed=3.6;
  let pos={x:600,y:400};
  let keys={};

  const SPRITES={
    idle:'{{ url_for("static", filename="img/empresa/personagem.jpg") }}',
    walk:'{{ url_for("static", filename="img/empresa/personagem.jpg") }}'
  };

  function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
  function updateCamera(){
    cam.x=clamp(pos.x-VIEW_W/2,0,MAP_W-VIEW_W);
    cam.y=clamp(pos.y-VIEW_H/2,0,MAP_H-VIEW_H);
    map.style.transform=`translate(${-cam.x}px,${-cam.y}px)`;
  }
  function updatePlayerDOM(){
    player.style.left=pos.x+'px';
    player.style.top=pos.y+'px';
  }
  function detectZone(){
    const pRect={left:pos.x-24,top:pos.y-40,right:pos.x+24,bottom:pos.y+40};
    let found=null;
    zones.forEach(z=>{
      const rect=z.getBoundingClientRect();
      const mapRect=map.getBoundingClientRect();
      const zleft=rect.left-mapRect.left+cam.x;
      const ztop=rect.top-mapRect.top+cam.y;
      const zright=zleft+rect.width;
      const zbottom=ztop+rect.height;
      if(!(pRect.right<zleft||pRect.left>zright||pRect.bottom<ztop||pRect.top>zbottom)){
        found=z.dataset.zone;
      }
    });
    return found;
  }
  function enterZone(zone){
    if(!zone){locationBox.innerText='Recep√ß√£o';return;}
    locationBox.innerText=zone.charAt(0).toUpperCase()+zone.slice(1);
    const allowed=PERMS[zone]===true||PERMS[zone]==='true';
    if(!allowed){
      statusBox.innerText=`Acesso negado √† ${locationBox.innerText}.`;
    }else{
      statusBox.innerText=`Acesso permitido √† ${locationBox.innerText}.`;
      if(zone==='recepcao'&&!modalShown){
        modal.classList.remove('hidden');
        modalShown=true;
      }
    }
  }

  window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;if(['arrowup','arrowdown','arrowleft','arrowright'].includes(e.key.toLowerCase()))e.preventDefault();});
  window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});

  document.getElementById('btnFull').addEventListener('click',()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();});
  let muted=false;
  document.getElementById('btnMute').addEventListener('click',()=>{muted=!muted;document.getElementById('btnMute').innerText=muted?'üîá Som':'üîä Som';});

  function loop(){
    let moved=false;
    if(keys['a']||keys['arrowleft']){pos.x-=speed;moved=true;}
    if(keys['d']||keys['arrowright']){pos.x+=speed;moved=true;}
    if(keys['w']||keys['arrowup']){pos.y-=speed;moved=true;}
    if(keys['s']||keys['arrowdown']){pos.y+=speed;moved=true;}
    pos.x=clamp(pos.x,24,MAP_W-24);
    pos.y=clamp(pos.y,40,MAP_H-40);
    playerSprite.src=moved?SPRITES.walk:SPRITES.idle;
    updatePlayerDOM();
    updateCamera();
    enterZone(detectZone());
    requestAnimationFrame(loop);
  }

  updatePlayerDOM();
  updateCamera();
  loop();
})();
</script>
{% endblock %}
