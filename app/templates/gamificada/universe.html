{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/universe.css') }}">
{% endblock %}

{% block content %}
<div class="universe-container theme-{{ area_name }}">
    <header class="universe-header">
        <h1>{{ area_title }}</h1>
        <div class="controls">
            <button id="btnFull" class="ctrl-btn">üïπÔ∏è Tela Cheia</button>
            <button id="btnMute" class="ctrl-btn">üîä Som</button>
            <span class="hint">Use WASD ou setas para se mover</span>
        </div>
    </header>

    <main class="universe-main">
        <div class="viewport" id="viewport">
            <div id="mapLayer" class="map-layer {{ 'map-inicial' if area_name == 'inicial' else 'map-campus' }}">
                {% if area_name == 'inicial' %}
                    <!-- MAPA INICIAL -->
                    <div class="background" style="background-image: url('{{ url_for('static', filename='img/inicial/mapa.jpg') }}');"></div>

                    <div class="zone zone-jax" title="Universo JAX" data-name="Universo JAX">
                        <img src="{{ url_for('static', filename='img/inicial/arte_jax.jpg') }}" alt="Universo JAX">
                        <div class="zone-label">Universo JAX</div>
                    </div>

                    <div class="zone zone-educacional" data-link="/educacional" data-name="√Årea Educacional">
                        <img src="{{ url_for('static', filename='img/inicial/escola.jpg') }}" alt="√Årea Educacional">
                        <div class="zone-label">√Årea Educacional</div>
                    </div>

                    <div class="zone zone-empresarial" data-link="/empresarial" data-name="√Årea Empresarial">
                        <img src="{{ url_for('static', filename='img/inicial/empresa.jpg') }}" alt="√Årea Empresarial">
                        <div class="zone-label">√Årea Empresarial</div>
                    </div>

                    <div class="zone zone-entretenimento" data-link="/entretenimento" data-name="√Årea de Entretenimento">
                        <img src="{{ url_for('static', filename='img/inicial/entretenimento.jpg') }}" alt="√Årea de Entretenimento">
                        <div class="zone-label">√Årea de Entretenimento</div>
                    </div>

                    <div class="zone zone-impacto" data-link="/jax_jornada" data-name="Impacto Social">
                        <img src="{{ url_for('static', filename='img/inicial/brasil.jpg') }}" alt="Impacto Social">
                        <div class="zone-label">Como o JAX muda o Brasil?</div>
                    </div>

                {% elif area_name == 'educacional' %}
                    <!-- CAMPUS EDUCACIONAL -->
                    <div class="layer bg far" style="background-image:url('{{ url_for('static', filename='img/campus/corredor.jpg') }}');"></div>
                    <div class="layer bg mid" style="background-image:url('{{ url_for('static', filename='img/campus/corredor.jpg') }}'); opacity:0.9;"></div>

                    <div class="zone zone-park" data-zone="park" data-allowed="true" data-name="Entrada">
                        <img src="{{ url_for('static', filename='img/campus/entrada.jpg') }}" alt="Entrada">
                        <div class="zone-label">Entrada</div>
                    </div>

                    <div class="zone zone-classroom" data-zone="classroom" data-allowed="true" data-name="Sala de Aula">
                        <img src="{{ url_for('static', filename='img/campus/sala-aula.jpg') }}" alt="Sala de Aula">
                        <div class="zone-label">Sala de Aula</div>
                    </div>

                    <div class="zone zone-mural" data-zone="mural" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}" data-name="Mural Oficial">
                        <img src="{{ url_for('static', filename='img/campus/mural_projetos.jpg') }}" alt="Mural">
                        <div class="zone-label">Mural Oficial</div>
                    </div>

                    <div class="zone zone-director" data-zone="director" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}" data-name="Diretoria">
                        <img src="{{ url_for('static', filename='img/campus/diretoria.jpg') }}" alt="Diretoria">
                        <div class="zone-label">Sala da Diretoria</div>
                    </div>

                    <div class="zone zone-teachers" data-zone="teachers" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}" data-name="Sala dos Professores">
                        <img src="{{ url_for('static', filename='img/campus/sala-professores.png') }}" alt="Sala dos Professores">
                        <div class="zone-label">Sala dos Professores</div>
                    </div>

                    <img class="npc" src="{{ url_for('static', filename='img/avatar/npc.png') }}" alt="NPC" style="left: 700px; top: 420px;">

                {% elif area_name == 'empresarial' %}
                    <!-- EMPRESARIAL -->
                    <div class="layer bg far" style="background-image:url('{{ url_for('static', filename='img/empresa/empresa.jpg') }}');"></div>
                    <div class="layer bg mid" style="background-image:url('{{ url_for('static', filename='img/empresa/empresa.jpg') }}'); opacity:0.9;"></div>

                    <div class="zone zone-recepcao" data-zone="recepcao" data-allowed="true" data-name="Recep√ß√£o">
                        <img src="{{ url_for('static', filename='img/empresa/recepcao.jpg') }}" alt="Recep√ß√£o">
                        <div class="zone-label">Recep√ß√£o</div>
                    </div>

                    <div class="zone zone-coworking" data-zone="coworking" data-allowed="true" data-name="Coworking">
                        <img src="{{ url_for('static', filename='img/empresa/sala-coworking.jpg') }}" alt="Coworking">
                        <div class="zone-label">Sala Coworking</div>
                    </div>

                    <div class="zone zone-tecnica" data-zone="tecnica" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}" data-name="Sala T√©cnica">
                        <img src="{{ url_for('static', filename='img/empresa/sala-tecnica.jpg') }}" alt="Sala T√©cnica">
                        <div class="zone-label">Sala T√©cnica</div>
                    </div>

                    <div class="zone zone-pessoas" data-zone="pessoas" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}" data-name="Sala de Pessoas">
                        <img src="{{ url_for('static', filename='img/empresa/sala-pessoas.jpeg') }}" alt="Sala de Pessoas">
                        <div class="zone-label">Sala de Pessoas</div>
                    </div>

                    <div class="zone zone-comercial" data-zone="comercial" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}" data-name="Sala Comercial">
                        <img src="{{ url_for('static', filename='img/empresa/sala-comercial.jpg') }}" alt="Sala Comercial">
                        <div class="zone-label">Sala Comercial</div>
                    </div>

                    <div class="zone zone-reunioes" data-zone="reunioes" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}" data-name="Sala de Reuni√µes">
                        <img src="{{ url_for('static', filename='img/empresa/sala-reunioes.jpg') }}" alt="Sala de Reuni√µes">
                        <div class="zone-label">Sala de Reuni√µes</div>
                    </div>

                    <img class="npc" src="{{ url_for('static', filename='img/avatar/npc.png') }}" alt="NPC" style="left: 700px; top: 420px;">

                {% elif area_name == 'entretenimento' %}
                    <!-- ENTRETENIMENTO -->
                    <div class="layer bg far" style="background-image:url('{{ url_for('static', filename='img/parque/parque_municipal.jpeg') }}');"></div>
                    <div class="layer bg mid" style="background-image:url('{{ url_for('static', filename='img/parque/parque_municipal.jpeg') }}'); opacity:0.9;"></div>

                    <div class="zone zone-entry" data-zone="entry" data-allowed="true" data-name="Entrada">
                        <img src="{{ url_for('static', filename='img/parque/entrada_parque-municipal.jpeg') }}" alt="Entrada do Parque">
                        <div class="zone-label">Entrada</div>
                    </div>

                    <div class="zone zone-lake" data-zone="lake" data-allowed="true" data-name="Lago Central">
                        <img src="{{ url_for('static', filename='img/parque/lago-central.jpeg') }}" alt="Lago Central">
                        <div class="zone-label">Lago Central</div>
                    </div>

                    <div class="zone zone-sport" data-zone="sport" data-allowed="true" data-name="Espa√ßo Esporte">
                        <img src="{{ url_for('static', filename='img/parque/espaco-esporte.jpeg') }}" alt="Espa√ßo Esporte">
                        <div class="zone-label">Espa√ßo Esporte</div>
                    </div>

                    <div class="zone zone-culture" data-zone="culture" data-allowed="true" data-name="Espa√ßo Cultura">
                        <img src="{{ url_for('static', filename='img/parque/espaco-cultura.jpg') }}" alt="Espa√ßo Cultura">
                        <div class="zone-label">Espa√ßo Cultura</div>
                    </div>

                    <div class="zone zone-nerd" data-zone="nerd" data-allowed="true" data-name="Espa√ßo Nerd">
                        <img src="{{ url_for('static', filename='img/parque/espaco-nerd.jpg') }}" alt="Espa√ßo Nerd">
                        <div class="zone-label">Espa√ßo Nerd</div>
                    </div>

                    <img class="npc" src="{{ url_for('static', filename='img/avatar/npc.png') }}" alt="NPC" style="left: 700px; top: 420px;">
                {% endif %}

                <!-- PERSONAGEM -->
                <div id="player" class="player">
                    <img src="{{ player_sprite }}" alt="Personagem">
                </div>
            </div>
        </div>

        <!-- PAINEL LATERAL -->
        <aside class="side-panel">
            <div class="panel-block">
                <h3>{% if area_name == 'inicial' %}Bem-vindo{% else %}Localiza√ß√£o{% endif %}</h3>
                {% if area_name == 'inicial' %}
                    {% if current_user %}
                        <p>Ol√°, {{ current_user.username }}!</p>
                    {% else %}
                        <p>Explore o Universo JAX e descubra novas oportunidades.</p>
                        <a href="/login" class="modal-btn" style="display: inline-block; text-decoration: none; margin-top: 10px;">Entrar</a>
                    {% endif %}
                {% else %}
                    <div id="location">{{ default_location }}</div>
                {% endif %}
            </div>

            {% if area_name != 'inicial' %}
            <div class="panel-block">
                <h3>A√ß√µes R√°pidas</h3>
                {% if area_name == 'educacional' %}
                    <button class="tele ctrl-btn" data-target="park">Ir ao Parque</button>
                    <button class="tele ctrl-btn" data-target="classroom">Ir √† Sala</button>
                    <button class="tele ctrl-btn" data-target="mural" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}">Ir ao Mural</button>
                    <button class="tele ctrl-btn" data-target="director" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}">Ir √† Diretoria</button>
                    <button class="tele ctrl-btn" data-target="teachers" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}">Ir √† Sala dos Professores</button>
                {% elif area_name == 'empresarial' %}
                    <button class="tele ctrl-btn" data-target="recepcao">Ir √† Recep√ß√£o</button>
                    <button class="tele ctrl-btn" data-target="coworking">Ir ao Coworking</button>
                    <button class="tele ctrl-btn" data-target="tecnica" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}">Ir √† Sala T√©cnica</button>
                    <button class="tele ctrl-btn" data-target="pessoas" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}">Ir √† Sala de Pessoas</button>
                    <button class="tele ctrl-btn" data-target="comercial" data-allowed="{{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }}">Ir √† Sala Comercial</button>
                    <button class="tele ctrl-btn" data-target="reunioes" data-allowed="{{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}">Ir √† Sala de Reuni√µes</button>
                {% elif area_name == 'entretenimento' %}
                    <button class="tele ctrl-btn" data-target="entry">Ir √† Entrada</button>
                    <button class="tele ctrl-btn" data-target="lake">Ir ao Lago Central</button>
                    <button class="tele ctrl-btn" data-target="sport">Ir ao Espa√ßo Esporte</button>
                    <button class="tele ctrl-btn" data-target="culture">Ir ao Espa√ßo Cultura</button>
                    <button class="tele ctrl-btn" data-target="nerd">Ir ao Espa√ßo Nerd</button>
                {% endif %}
            </div>
            {% endif %}

            <div class="panel-block">
                <h3>Status</h3>
                <div id="statusMsg">{{ welcome_message }}</div>
                <div class="small">Seu acesso:
                    {% if current_user %}
                        {{ current_user.profile }}
                    {% else %}
                        visitante
                    {% endif %}
                </div>
            </div>
        </aside>
    </main>
</div>

<!-- MODAL -->
<div id="welcomeModal" class="modal hidden">
    <div class="modal-content">
        <h2>{{ modal_title }}</h2>
        <p>{{ modal_message }}</p>
        <button id="closeModal" class="modal-btn">Entrar</button>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/universe-core.js') }}"></script>
<script>
    // Configura√ß√µes
    {% if area_name == 'educacional' %}
    const PERMS = {
        mural: {{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }},
        director: {{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }},
        teachers: {{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}
    };
    {% elif area_name == 'empresarial' %}
    const PERMS = {
        tecnica: {{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }},
        pessoas: {{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }},
        comercial: {{ 'true' if (current_user and current_user.profile in ['aluno','admin','funcionario']) else 'false' }},
        reunioes: {{ 'true' if (current_user and current_user.profile in ['admin','funcionario']) else 'false' }}
    };
    {% else %}
    const PERMS = {};
    {% endif %}

    // Configura√ß√£o base
    const config = {
        areaName: '{{ area_name }}',
        {% if area_name == 'inicial' %}
        mapSize: { width: 2000, height: 1200 },
        initialPos: { x: 400, y: 550 },
        speed: 4
        {% else %}
        mapSize: { width: 2600, height: 1400 },
        initialPos: { x: 600, y: 400 },
        speed: 3.6,
        defaultLocation: '{{ default_location }}',
        {% if area_name == 'educacional' %}
        triggerModalZone: 'park',
        permissions: {
            park: true, classroom: true,
            mural: PERMS.mural, director: PERMS.director, teachers: PERMS.teachers
        },
        zonePositions: {
            park: { x: 450, y: 300 }, classroom: { x: 1140, y: 290 },
            mural: { x: 450, y: 700 }, director: { x: 1130, y: 650 },
            teachers: { x: 1860, y: 670 }
        }
        {% elif area_name == 'empresarial' %}
        triggerModalZone: 'recepcao',
        permissions: {
            recepcao: true, coworking: true,
            tecnica: PERMS.tecnica, pessoas: PERMS.pessoas,
            comercial: PERMS.comercial, reunioes: PERMS.reunioes
        },
        zonePositions: {
            recepcao: { x: 450, y: 300 }, coworking: { x: 1140, y: 290 },
            tecnica: { x: 450, y: 700 }, pessoas: { x: 1130, y: 650 },
            comercial: { x: 1860, y: 290 }, reunioes: { x: 1860, y: 670 }
        }
        {% elif area_name == 'entretenimento' %}
        permissions: {
            entry: true, lake: true, sport: true, culture: true, nerd: true
        },
        zonePositions: {
            entry: { x: 450, y: 300 }, lake: { x: 1140, y: 290 },
            sport: { x: 450, y: 700 }, culture: { x: 1130, y: 650 },
            nerd: { x: 1860, y: 670 }
        }
        {% endif %}
        {% endif %}
    };

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Starting {{ area_name }} game with config:', config);
        
        {% if area_name == 'inicial' %}
            const game = new InitialMapGame(config);
        {% else %}
            const game = new CampusMapGame(config);
        {% endif %}
    });

    async function loadCustomAvatar() {
    try {
        const response = await fetch('/api/avatar/current');
        const result = await response.json();
        
        if (result.success && result.avatar) {
            // Aqui voc√™ implementaria a l√≥gica para renderizar
            // o avatar customizado em vez da imagem fixa
            console.log('Avatar customizado carregado:', result.avatar);
        }
    } catch (error) {
        console.error('Erro ao carregar avatar:', error);
    }
}

// Chamar ap√≥s o carregamento da p√°gina
document.addEventListener('DOMContentLoaded', loadCustomAvatar);

</script>
{% endblock %}
