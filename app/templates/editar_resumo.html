{% extends 'base.html' %}

{% block styles %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/jaxresume_editor.css') }}">
{% endblock %}

{% block content %}
<div id="jaxresume-container">
    <h1 id="jaxresume-title">Edite o seu JAXResume</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}


    <form id="jaxresume-form" method="POST" enctype="multipart/form-data" class="modern-form">
        <div class="form-grid">
            <div class="form-group">
                <label for="title" class="form-label">Título</label>
                <input type="text" name="title" id="title" class="form-input"
                    value="{{ post.title if post else '' }}" required>
            </div>
            <div class="form-group">
                <label for="subtitle" class="form-label">Subtítulo</label>
                <input type="text" name="subtitle" id="subtitle" class="form-input"
                    value="{{ post.subtitle if post else '' }}">
            </div>
            <div class="form-group">
                <label for="image" class="form-label">Imagem</label>
                {% if post and post.image %}
                    <div class="current-image">
                        <img src="{{ url_for('static', filename='images/jax_resume/' ~ post.image) }}" alt="Imagem atual" style="max-width: 200px;">
                        <label>
                            <input type="checkbox" name="remove_image" value="1"> Remover imagem
                        </label>
                    </div>
                    <!-- Campo oculto para manter imagem antiga -->
                    <input type="hidden" name="current_image" value="{{ post.image }}">
                {% endif %}
                <input type="file" name="image" id="image" class="form-input-file">
                <small class="hint">Se não selecionar nada, a imagem atual será mantida.</small>
            </div>
            <div class="form-group">
                <label for="theme" class="form-label">Tema</label>
                <input type="text" name="theme" id="theme" class="form-input"
                    value="{{ post.theme if post else '' }}">
            </div>
            <div class="form-group">
                <label for="subtheme" class="form-label">Subtema</label>
                <input type="text" name="subtheme" id="subtheme" class="form-input"
                    value="{{ post.subtheme if post else '' }}">
            </div>
        </div>

    <div class="form-group">
        <label for="visibility" class="form-label">Visibilidade</label>
        <select name="visibility" id="visibility" class="form-input">
            <option value="aberta" 
                {% if post and post.visibility == 'aberta' %}selected{% endif %}>Aberta (público geral)</option>
            <option value="fechada_nativa" 
                {% if post and post.visibility == 'fechada_nativa' %}selected{% endif %}>Fechada - Nativa (qualquer usuário cadastrado)</option>
            <option value="fechada_aluno" 
                {% if post and post.visibility == 'fechada_aluno' %}selected{% endif %}>Fechada - Aluno (aluno, admin ou funcionário)</option>
            <option value="fechada_interna" 
                {% if post and post.visibility == 'fechada_interna' %}selected{% endif %}>Fechada - Interna (somente admin ou funcionário)</option>
        </select>
    </div>

        <div id="editor-preview-container">
            <div class="editor-section">
                <h2 class="section-title">Editor</h2>
                <div id="editor" class="editor-box">{{ post.content|safe if post else '' }}</div>
                <input type="hidden" name="content" id="hiddenContent">
            </div>
            <div class="preview-section">
                <h2 class="section-title">Pré-visualização</h2>
                <div id="preview" class="preview-box"></div>
            </div>
        </div>

    <div class="button-wrapper">
        <button type="submit" id="save-button" class="btn-primary">Salvar Resumo</button>
        <a href="{{ url_for('main.lista_resumos') }}" class="btn-secondary">Ver Lista de JAXResumes</a>
    </div>

    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var quill = new Quill('#editor', { theme: 'snow' });
    document.getElementById('jaxresume-form').onsubmit = function() {
        document.getElementById('hiddenContent').value = quill.root.innerHTML;
    };
    quill.on('text-change', function() {
        document.getElementById('preview').innerHTML = quill.root.innerHTML;
    });
    document.getElementById('preview').innerHTML = quill.root.innerHTML;
</script>
{% endblock %}
